<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>HTML Document Template</title>
  <link href="styles.css" rel="stylesheet">
</head>

<body>
  <div class="header__menu">
    <ul>
      <li><a href="1">1</a></li>
      <li><a href="2">2</a></li>
      <li><a href="3">3</a></li>
      <li><a href="4">4</a></li>
      <li><a href="5">5</a></li>
      <li><a href="6">6</a></li>
      <li><a href="7">7</a></li>
      <li><a href="8">8</a></li>
      <li><a href="9">9</a></li>
      <li><a href="10">10</a></li>
      <li><a href="11">11</a></li>
      <li><a href="12">12</a></li>
      <li><a href="13">13</a></li>
      <li><a href="14">14</a></li>
      <li><a href="15">15</a></li>
      <li><a href="16">16</a></li>
    </ul>
  </div>
  <h1>3</h1>
  <H2 class="OU">
    Оперативный учет
  </H2>
  <pre>
    <p>///// Общий модуль ОбработкаТабличнойЧасти</p>
    Процедура РассчитатьСуммуВСтроке(ТекСтрока) Экспорт
      ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
    КонецПроцедуры   
    
    <p>///// Общий модуль УчетнаяПолитика</p>  
    Функция МетодСписанияСебестоимости(Дата) Экспорт
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
      "ВЫБРАТЬ
      |	УчетнаяПолитикаСрезПоследних.МетодСписанияСебестоимости КАК МетодСписанияСебестоимости
      |ИЗ
      |	РегистрСведений.УчетнаяПолитика.СрезПоследних(&Период, ) КАК УчетнаяПолитикаСрезПоследних";
      
      Запрос.УстановитьПараметр("Период", Дата);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Если РезультатЗапроса.Пустой() Тогда
        
        Возврат Неопределено;
        
      КонецЕсли;
      
      Выборка = РезультатЗапроса.Выбрать();
      Выборка.Следующий();
      
      Возврат Выборка.МетодСписанияСебестоимости;	
      
    КонецФункции
    
    <p>///// Общий модуль НумерацияОбъектов</p> 
    Функция НомерНаПечать(Знач НомерОбъекта) Экспорт
      Пока Лев(НомерОбъекта, 1) = "0" Цикл
        НомерОбъекта = Сред(НомерОбъекта, 2);
      КонецЦикла;
      
      Возврат НомерОбъекта;
    КонецФункции
    
    <p>///// Документ НазначениеУчетнойПолитики</p>   
    Процедура ОбработкаПроведения(Отказ, Режим)
      
      СтарыйМетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата - 1);
      Если СтарыйМетодСписанияСебестоимости = МетодСписанияСебестоимости Тогда
        Отказ = Истина;
        
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Метод списания себестоимости соответствует уже установленному методу";
        Сообщение.Сообщить();
        
        Возврат;
      КонецЕсли;
      
      // регистр УчетнаяПолитика
      Движения.УчетнаяПолитика.Записывать = Истина;
      Движение = Движения.УчетнаяПолитика.Добавить();
      Движение.Период = Дата;
      Движение.МетодСписанияСебестоимости = МетодСписанияСебестоимости;
      
      Если МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика.Среднее Тогда
      
        Движения.ОстаткиНоменклатуры.Записывать = Истина;
        Движения.Записать();
        
        Движения.ОстаткиНоменклатуры.Записывать = Истина;
        
        Блокировка = Новый БлокировкаДанных;
        ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНоменклатуры");
        ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
        Блокировка.Заблокировать();
    
        Запрос = Новый Запрос;
        Запрос.Текст = 
          "ВЫБРАТЬ
          |	ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
          |	ОстаткиНоменклатурыОстатки.Партия КАК Партия,
          |	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК Количество,
          |	ОстаткиНоменклатурыОстатки.СтоимостьОстаток КАК Стоимость
          |ИЗ
          |	РегистрНакопления.ОстаткиНоменклатуры.Остатки(&МоментВремени, ) КАК ОстаткиНоменклатурыОстатки
          |ИТОГИ
          |	СУММА(Количество),
          |	СУММА(Стоимость)
          |ПО
          |	Номенклатура";
        
        Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
        
        РезультатЗапроса = Запрос.Выполнить();
        
        ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
        
        Пока ВыборкаНоменклатура.Следующий() Цикл
          Движение = Движения.ОстаткиНоменклатуры.ДобавитьПриход();
          ЗаполнитьЗначенияСвойств(Движение, ВыборкаНоменклатура);
          Движение.Период = Дата;
        
          ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать();	
          Пока ВыборкаДетальныеЗаписи.Следующий() Цикл		
            Движение = Движения.ОстаткиНоменклатуры.ДобавитьРасход();
            ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
            Движение.Период = Дата;			
          КонецЦикла;
        КонецЦикла;
        
      КонецЕсли;
      
    КонецПроцедуры
    
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      Дата = НачалоМесяца(Дата);
    КонецПроцедуры
    
    <p>///// Документ ПриходнаяНакладная</p>
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)	
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    Процедура ОбработкаПроведения(Отказ, Режим)
    
      МетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата);
      
      Если МетодСписанияСебестоимости = Неопределено Тогда
        
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Не указан метод списания себестоимости в учетной политике";
        Сообщение.Сообщить();
        
        Отказ = Истина;
        Возврат;
        
      КонецЕсли;
      
      Если МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика.Среднее Тогда
        Партия = Документы.ПриходнаяНакладная.ПустаяСсылка();
      Иначе
        Партия = Ссылка;
      КонецЕсли;
      
      Движения.ОстаткиНоменклатуры.Записывать = Истина;
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
        |ИЗ
        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
        |
        |СГРУППИРОВАТЬ ПО
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура";
      
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Пока Выборка.Следующий() Цикл
        Движение = Движения.ОстаткиНоменклатуры.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
        Движение.Период = Дата;
        Движение.Номенклатура = Выборка.Номенклатура;
        Движение.Партия = Партия;
        Движение.Количество = Выборка.Количество;
        Движение.Стоимость = Выборка.Сумма;
      КонецЦикла;
       
    КонецПроцедуры
    
    <p>///// Документ РасходнаяНакладная</p> 
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      МетодСписанияСебестоимости = УчетнаяПолитика.МетодСписанияСебестоимости(Дата);
      
      Если МетодСписанияСебестоимости = Неопределено Тогда
        
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Не указан метод списания себестоимости в учетной политике";
        Сообщение.Сообщить();
        
        Отказ = Истина;
        Возврат;
        
      КонецЕсли;
      
      // удаление движения
      Движения.ОстаткиНоменклатуры.Записывать = Истина;
      Движения.Записать();
      
      // взвели флаг
      Движения.ОстаткиНоменклатуры.Записывать = Истина;	
      
      Блокировка = Новый БлокировкаДанных;
      ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНоменклатуры");
      ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
      ЭлементБлокировки.ИсточникДанных = СписокНоменклатуры;
      ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Номенклатура", "Номенклатура");
      Блокировка.Заблокировать();
        
      Запрос = Новый Запрос;
      Запрос.Текст = 
      "ВЫБРАТЬ
      |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
      |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
      |ПОМЕСТИТЬ втТЧТовары
      |ИЗ
      |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
      |ГДЕ
      |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
      |
      |СГРУППИРОВАТЬ ПО
      |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
      |
      |ИНДЕКСИРОВАТЬ ПО
      |	Номенклатура
      |;
      |
      |////////////////////////////////////////////////////////////////////////////////
      |ВЫБРАТЬ
      |	втТЧТовары.Номенклатура КАК Номенклатура,
      |	втТЧТовары.Номенклатура.Представление КАК НоменклатураПредставление,
      |	втТЧТовары.Количество КАК Количество,
      |	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
      |	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.СтоимостьОстаток, 0) КАК СтоимостьОстаток,
      |	ОстаткиНоменклатурыОстатки.Партия КАК Партия
      |ИЗ
      |	втТЧТовары КАК втТЧТовары
      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
      |				&МоментВремени,
      |				Номенклатура В
      |						(ВЫБРАТЬ
      |							втТЧТовары.Номенклатура КАК Номенклатура
      |						ИЗ
      |							втТЧТовары КАК втТЧТовары)) КАК ОстаткиНоменклатурыОстатки
      |		ПО втТЧТовары.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура
      |
      |УПОРЯДОЧИТЬ ПО
      |	ОстаткиНоменклатурыОстатки.Партия.МоментВремени
      |ИТОГИ
      |	МАКСИМУМ(Количество),
      |	СУММА(КоличествоОстаток)
      |ПО
      |	Номенклатура";
      
      Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
      
      Пока ВыборкаНоменклатура.Следующий() Цикл
        
        Если ВыборкаНоменклатура.Количество > ВыборкаНоменклатура.КоличествоОстаток Тогда
          
          Отказ = Истина;
          
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = СтрШаблон("Недостаточно товара %1 в количестве %2", 
          ВыборкаНоменклатура.НоменклатураПредставление, 
          ВыборкаНоменклатура.Количество - ВыборкаНоменклатура.КоличествоОстаток);
          Сообщение.Сообщить();
          
        КонецЕсли;
        
        Если Отказ Тогда
          Продолжить;
        КонецЕсли;
        
        КоличествоСписать = ВыборкаНоменклатура.Количество;
        
        ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать();
        
        Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
          
          Количество = Мин(КоличествоСписать, ВыборкаДетальныеЗаписи.КоличествоОстаток);
          
          Если Количество = ВыборкаДетальныеЗаписи.КоличествоОстаток Тогда
            Себестоимость = ВыборкаДетальныеЗаписи.СтоимостьОстаток;
          Иначе
            Себестоимость = Количество / ВыборкаДетальныеЗаписи.КоличествоОстаток * ВыборкаДетальныеЗаписи.СтоимостьОстаток;
          КонецЕсли;
          
          Движение = Движения.ОстаткиНоменклатуры.ДобавитьРасход();
          Движение.Период = Дата;
          Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
          Движение.Партия = ВыборкаДетальныеЗаписи.Партия;
          Движение.Количество = Количество;
          Движение.Стоимость = Себестоимость;
          
          КоличествоСписать = КоличествоСписать - Количество;
          
          Если КоличествоСписать <= 0 Тогда
            Прервать;
          КонецЕсли;
          
        КонецЦикла;
      КонецЦикла;
      
    КонецПроцедуры
    
    <p>///// Модуль формы</p>
    &НаКлиенте
    Процедура СписокНоменклатурыКоличествоПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    
    &НаКлиенте
    Процедура СписокНоменклатурыЦенаПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    <embed src="pdf/ОбщееОУ3.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/ОУ3.jpg">
    <H2 class="OU">
      Бухгалтерский учет
    </H2>
    <p>///// Общий модуль ОбработкаТабличнойЧастиКлиент</p>
    Процедура РассчитатьСуммуВСтроке(ТекСтрока) Экспорт
      ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
    КонецПроцедуры  
    
    <p>///// Общий модуль ОбщегоНазначенияВызовСервера</p>
    Функция ВалютаДоговора(Договор) Экспорт
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	Договоры.Валюта КАК Валюта
        |ИЗ
        |	Справочник.Договоры КАК Договоры
        |ГДЕ
        |	Договоры.Ссылка = &Ссылка";
      
      Запрос.УстановитьПараметр("Ссылка", Договор);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Если Выборка.Следующий() Тогда
        Возврат Выборка.Валюта;
      КонецЕсли;
      
      Возврат Неопределено;
      
    КонецФункции
    
    <p>///// Общий модуль РаботаСоСтрокамиСервер</p>
    Функция УдалитьВедущиеНулиИзСтроки(Знач Строка) Экспорт
      Пока Лев(Строка, 1) = "0" Цикл
        Строка = Сред(Строка, 2);
      КонецЦикла;
      Возврат Строка;
    КонецФункции
    
    <p>///// Документ Операция</p>   
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      Если Не Движения.Управленческий.Записывать Тогда
        Движения.Управленческий.Прочитать();
        Движения.Управленческий.Записывать = Истина;
      КонецЕсли;
      
      Для Каждого Движение Из Движения.Управленческий Цикл
        Движение.Период = Дата;
        Движение.Активность = Не ПометкаУдаления;
      КонецЦикла;
    КонецПроцедуры
    
    Процедура ПриКопировании(ОбъектКопирования)	
      Выборка = РегистрыБухгалтерии.Управленческий.ВыбратьПоРегистратору(ОбъектКопирования.Ссылка);
      Пока Выборка.Следующий() Цикл
        Движение = Движения.Управленческий.Добавить();
        ЗаполнитьЗначенияСвойств(Движение, Выборка);
        ЗаполнитьЗначенияСвойств(Движение.СубконтоДт, Выборка.СубконтоДт);
        ЗаполнитьЗначенияСвойств(Движение.СубконтоКт, Выборка.СубконтоКт);
      КонецЦикла;
    КонецПроцедуры
     
    <p>///// Документ ПриходнаяНакладная</p>
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    <p>///// Документ РасходнаяНакладная</p> 
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.Управленческий.Записывать = Истина;
      
      Движение = Движения.Управленческий.Добавить();
      Движение.Период = Дата;
      Движение.СчетДт = ПланыСчетов.Управленческий.Покупатели;
      Движение.ВалютаДт = Валюта;
      Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Покупатели] = Контрагент;
      Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Договор;
      Движение.СуммаВалДт = СуммаПоДокументу;
      Движение.СчетКт = ПланыСчетов.Управленческий.ПрибылиУбытки;
      
      Курс = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(Дата, Новый Структура("Валюта", Валюта)).Курс;
      Если Валюта <> Справочники.Валюты.РоссийскийРубль И Курс = 0 Тогда
        Отказ = Истина;
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Не задан курс валюты договора";
        Сообщение.Сообщить();
        Возврат;
      КонецЕсли;
      Курс = ?(Курс = 0, 1, Курс);
      
      Движение.Сумма = СуммаПоДокументу * Курс;
      
    КонецПроцедуры
    
    <p>///// Документ ПриходДенег</p>
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.Управленческий.Записывать = Истина;
      Движения.Записать();
      
      Движения.Управленческий.Записывать = Истина;
      
      Блокировка = Новый БлокировкаДанных;
      ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
      ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
      ЭлементБлокировки.УстановитьЗначение("Счет", ПланыСчетов.Управленческий.Покупатели);
      ЭлементБлокировки.УстановитьЗначение(ПланыВидовХарактеристик.ВидыСубконто.Покупатели, Контрагент);
      Блокировка.Заблокировать();
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	УправленческийОстатки.Субконто1 КАК Контрагент,
        |	УправленческийОстатки.Субконто2 КАК Договор,
        |	УправленческийОстатки.Валюта КАК Валюта,
        |	УправленческийОстатки.СуммаОстаток КАК СуммаРубОстаток,
        |	УправленческийОстатки.СуммаВалОстаток КАК СуммаВалОстаток
        |ПОМЕСТИТЬ втЗадолженности
        |ИЗ
        |	РегистрБухгалтерии.Управленческий.Остатки(&МоментВремени, Счет = &СчетПокупатели, &ВидыСубконто, Субконто1 = &Контрагент) КАК УправленческийОстатки
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	Валюта
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втЗадолженности.Контрагент КАК Контрагент,
        |	втЗадолженности.Договор КАК Договор,
        |	втЗадолженности.Валюта КАК Валюта,
        |	втЗадолженности.Валюта.Представление КАК ВалютаПредставление,
        |	ВЫБОР
        |		КОГДА втЗадолженности.Валюта <> ЗНАЧЕНИЕ(Справочник.Валюты.РоссийскийРубль)
        |			ТОГДА ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 0)
        |		ИНАЧЕ 1
        |	КОНЕЦ КАК Курс,
        |	ВЫРАЗИТЬ(ВЫБОР
        |		КОГДА втЗадолженности.Валюта <> ЗНАЧЕНИЕ(Справочник.Валюты.РоссийскийРубль)
        |			ТОГДА ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 0)
        |		ИНАЧЕ 1
        |	КОНЕЦ * втЗадолженности.СуммаВалОстаток КАК ЧИСЛО(12,2)) КАК СуммаРубОстаток,
        |	втЗадолженности.СуммаВалОстаток КАК СуммаВалОстаток
        |ИЗ
        |	втЗадолженности КАК втЗадолженности
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
        |				&МоментВремени,
        |				Валюта В
        |					(ВЫБРАТЬ
        |						втЗадолженности.Валюта КАК Валюта
        |					ИЗ
        |						втЗадолженности КАК втЗадолженности)) КАК КурсыВалютСрезПоследних
        |		ПО втЗадолженности.Валюта = КурсыВалютСрезПоследних.Валюта
        |
        |УПОРЯДОЧИТЬ ПО
        |	втЗадолженности.СуммаРубОстаток УБЫВ
        |ИТОГИ
        |	СУММА(СуммаРубОстаток)
        |ПО
        |	ОБЩИЕ";
      
      ВидыСубконто = Новый Массив;
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Покупатели);
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Договоры);
      
      Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
      Запрос.УстановитьПараметр("Контрагент", Контрагент);
      Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
      Запрос.УстановитьПараметр("СчетПокупатели", ПланыСчетов.Управленческий.Покупатели);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Если РезультатЗапроса.Пустой() Тогда
        Отказ = Истина;
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Нет данных для формирования движений";
        Сообщение.Сообщить();
        Возврат;
      КонецЕсли;
      
      ВыборкаОбщийИтог = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);	
      ВыборкаОбщийИтог.Следующий();		// Общий итог
      Если СуммаПоДокументу > ВыборкаОбщийИтог.СуммаРубОстаток Тогда
        Отказ = Истина;
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Попытка переплаты на сумму " + (СуммаПоДокументу - ВыборкаОбщийИтог.СуммаРубОстаток);
        Сообщение.Сообщить();
        Возврат;
      КонецЕсли;
        
      Выборка = ВыборкаОбщийИтог.Выбрать();
      
      СуммаКПогашению = СуммаПоДокументу;
      
      Пока Выборка.Следующий() И СуммаКПогашению > 0 Цикл
        
        Если Выборка.Курс = 0 Тогда
          Отказ = Истина;
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = "Не задан курс валюты " + Выборка.ВалютаПредставление;
          Сообщение.Сообщить();
        КонецЕсли;
        
        Если Отказ Тогда
          Продолжить;
        КонецЕсли;
        
        СуммаРуб = Мин(СуммаКПогашению, Выборка.СуммаРубОстаток);
        Если СуммаРуб = Выборка.СуммаРубОстаток Тогда
          СуммаВал = Выборка.СуммаВалОстаток;
        Иначе
          СуммаВал = Окр(СуммаРуб / Выборка.Курс, 2);
        КонецЕсли;
        
        Если СуммаВал > 0 Тогда
          Движение = Движения.Управленческий.Добавить();
          Движение.Период = Дата;
          Движение.СчетДт = ПланыСчетов.Управленческий.Касса;
          Движение.СчетКт = ПланыСчетов.Управленческий.Покупатели;
          Движение.ВалютаКт = Выборка.Валюта;
          Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Покупатели] = Контрагент;
          Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Выборка.Договор;
          Движение.СуммаВалКт = СуммаВал;
          Движение.Сумма = СуммаРуб;
          
          СуммаКПогашению = СуммаКПогашению - СуммаРуб;
        КонецЕсли;
        
      КонецЦикла;
      
    КонецПроцедуры
    
    <p>///// Модуль формы</p>
    &НаКлиенте
    Процедура СписокНоменклатурыКоличествоПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    
    &НаКлиенте
    Процедура СписокНоменклатурыЦенаПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    <embed src="pdf/ОбщееБУ3.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/БУ3.jpg">
    <H2 class="OU">
      Расчеты
    </H2>
    <p>///// Документ НачислениеЗарплаты</p>   
      Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
        Если ОсновныеНачисления.Количество() = 0 И ДополнительныеНачисления.Количество() = 0 Тогда
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = "Документ не заполнен";
          Сообщение.Сообщить();		           
          Отказ = Истина;
        КонецЕсли;
      КонецПроцедуры

      Процедура ОбработкаПроведения(Отказ, РежимПроведения)
        
        ПериодРегистрации = НачалоМесяца(Дата);
        КонецРасчетногоПериода = КонецМесяца(ПериодРегистрации);
        
        Движения.ОсновныеНачисления.Записывать = Истина;
        Для Каждого Строка Из ОсновныеНачисления Цикл
          Движение = Движения.ОсновныеНачисления.Добавить();
          ЗаполнитьЗначенияСвойств(Движение, Строка);
          Движение.ПериодРегистрации = ПериодРегистрации;
          Движение.ПериодДействияНачало = Строка.ДатаНачала;
          Движение.ПериодДействияКонец = КонецДня(Строка.ДатаОкончания);
        КонецЦикла;
        
        Движения.ДополнительныеНачисления.Записывать = Истина;
        Для Каждого Строка Из ДополнительныеНачисления Цикл
          Движение = Движения.ДополнительныеНачисления.Добавить();
          ЗаполнитьЗначенияСвойств(Движение, Строка);
          Движение.ПериодРегистрации = ПериодРегистрации;
          Если Строка.ВидРасчета = ПланыВидовРасчета.ДополнительныеНачисления.КомпенсацияНаРемонт Тогда
            Движение.БазовыйПериодНачало = ПериодРегистрации;
            Движение.БазовыйПериодКонец  = КонецРасчетногоПериода;
          КонецЕсли;
        КонецЦикла;	
        
        Движения.Записать();
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
          "ВЫБРАТЬ
          |	ОсновныеНачисленияДанныеГрафика.НомерСтроки КАК НомерСтроки,
          |	ОсновныеНачисленияДанныеГрафика.Сотрудник КАК Сотрудник,
          |	ЕСТЬNULL(ОсновныеНачисленияДанныеГрафика.ЧасовФактическийПериодДействия, 0) КАК ОтработаноЧасов,
          |	ЕСТЬNULL(ОсновныеНачисленияДанныеГрафика.ДнейФактическийПериодДействия, 0) КАК ОтработаноДней
          |ПОМЕСТИТЬ втНачисления
          |ИЗ
          |	РегистрРасчета.ОсновныеНачисления.ДанныеГрафика(
          |			Регистратор = &Регистратор
          |				И ВидРасчета В (&ВидыРасчета)) КАК ОсновныеНачисленияДанныеГрафика
          |
          |ИНДЕКСИРОВАТЬ ПО
          |	Сотрудник
          |;
          |
          |////////////////////////////////////////////////////////////////////////////////
          |ВЫБРАТЬ
          |	втНачисления.НомерСтроки КАК НомерСтроки,
          |	втНачисления.ОтработаноЧасов КАК ОтработаноЧасов,
          |	втНачисления.ОтработаноДней КАК ОтработаноДней,
          |	ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.ТарифнаяСтавка, 0) КАК ТарифнаяСтавка,
          |	ШтрафЗаПрогул.Значение КАК ШтрафЗаПрогул
          |ИЗ
          |	втНачисления КАК втНачисления
          |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОСотрудниках.СрезПоследних(
          |				&ПериодРегистрации,
          |				Сотрудник В
          |					(ВЫБРАТЬ
          |						втНачисления.Сотрудник КАК Сотрудник
          |					ИЗ
          |						втНачисления КАК втНачисления)) КАК СведенияОСотрудникахСрезПоследних
          |		ПО втНачисления.Сотрудник = СведенияОСотрудникахСрезПоследних.Сотрудник
          |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.ШтрафЗаПрогул КАК ШтрафЗаПрогул
          |		ПО (ИСТИНА)";
        
        ВидыРасчета = Новый Массив;
        ВидыРасчета.Добавить(ПланыВидовРасчета.ОсновныеНачисления.ОплатаПоЧасовомуТарифу);
        ВидыРасчета.Добавить(ПланыВидовРасчета.ОсновныеНачисления.Прогул);
        
        Запрос.УстановитьПараметр("ВидыРасчета", ВидыРасчета);
        Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
        Запрос.УстановитьПараметр("Регистратор", Ссылка);
        
        РезультатЗапроса = Запрос.Выполнить();
        
        Выборка = РезультатЗапроса.Выбрать();
        
        Для Каждого Движение Из Движения.ОсновныеНачисления Цикл
          
          Если ВидыРасчета.Найти(Движение.ВидРасчета) = Неопределено Тогда
            Продолжить;
          КонецЕсли;
          
          Выборка.Сбросить();
          Выборка.НайтиСледующий(Движение.НомерСтроки, "НомерСтроки");
          
          Если Движение.ВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.ОплатаПоЧасовомуТарифу Тогда
            Движение.Результат = Выборка.ТарифнаяСтавка * Выборка.ОтработаноЧасов;
            ЗаполнитьЗначенияСвойств(Движение, Выборка, "ТарифнаяСтавка, ОтработаноЧасов");
          ИначеЕсли Движение.ВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Прогул Тогда
            Движение.Результат = Выборка.ОтработаноДней * Выборка.ШтрафЗаПрогул;
            ЗаполнитьЗначенияСвойств(Движение, Выборка, "ОтработаноДней, ШтрафЗаПрогул");
          КонецЕсли;
          
        КонецЦикла;
        
        Движения.ОсновныеНачисления.Записать(, Истина);

        Движения.НаезженныеЧасы.Записать();
        
        //Блокировка = Новый БлокировкаДанных;
        //ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НаезженныеЧасы");
        //ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
        //
        //Запрос = Новый Запрос;
        //Запрос.Текст = 
        //	"ВЫБРАТЬ РАЗЛИЧНЫЕ
        //	|	ДополнительныеНачисления.Сотрудник КАК Сотрудник
        //	|ИЗ
        //	|	РегистрРасчета.ДополнительныеНачисления КАК ДополнительныеНачисления
        //	|ГДЕ
        //	|	ДополнительныеНачисления.Регистратор = &Регистратор
        //	|	И ДополнительныеНачисления.ВидРасчета = &ВидРасчетаКомпенсация";
        //
        //Запрос.УстановитьПараметр("ВидРасчетаКомпенсация", ПланыВидовРасчета.ДополнительныеНачисления.КомпенсацияНаРемонт);
        //Запрос.УстановитьПараметр("Регистратор", Ссылка);
        //
        //РезультатЗапроса = Запрос.Выполнить();
        //
        //ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
        //ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Сотрудник", "Сотрудник");
        //Блокировка.Заблокировать();
          
        Запрос = Новый Запрос;
        Запрос.Текст = 
          "ВЫБРАТЬ
          |	ДополнительныеНачисления.НомерСтроки КАК НомерСтроки,
          |	ДополнительныеНачисления.Сотрудник КАК Сотрудник,
          |	ЕСТЬNULL(ДополнительныеНачисленияБазаОсновныеНачисления.РезультатБаза, 0) КАК БазаНачислений
          |ПОМЕСТИТЬ втНачисления
          |ИЗ
          |	РегистрРасчета.ДополнительныеНачисления КАК ДополнительныеНачисления
          |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ДополнительныеНачисления.БазаОсновныеНачисления(
          |				&Измерения,
          |				&Измерения,
          |				,
          |				Регистратор = &Регистратор
          |					И ВидРасчета В (&ВидыРасчета)) КАК ДополнительныеНачисленияБазаОсновныеНачисления
          |		ПО ДополнительныеНачисления.НомерСтроки = ДополнительныеНачисленияБазаОсновныеНачисления.НомерСтроки
          |ГДЕ
          |	ДополнительныеНачисления.Регистратор = &Регистратор
          |
          |ИНДЕКСИРОВАТЬ ПО
          |	Сотрудник
          |;
          |
          |////////////////////////////////////////////////////////////////////////////////
          |ВЫБРАТЬ
          |	втНачисления.НомерСтроки КАК НомерСтроки,
          |	втНачисления.БазаНачислений КАК БазаНачислений,
          |	ЕСТЬNULL(НаезженныеЧасыОстатки.ЧасовОстаток, 0) КАК НаезженоЧасов,
          |	ЕСТЬNULL(ПоказателиРасчетаЗарплатыСрезПоследних.ПроцентКомпенсации, 0) КАК ПроцентКомпенсации,
          |	ПределНаезженныхЧасов.Значение КАК ПределНаезженныхЧасов
          |ИЗ
          |	втНачисления КАК втНачисления
          |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НаезженныеЧасы.Остатки(
          |				&НачалоСледующегоМесяца,
          |				Сотрудник В
          |					(ВЫБРАТЬ
          |						втНачисления.Сотрудник КАК Сотрудник
          |					ИЗ
          |						втНачисления КАК втНачисления)) КАК НаезженныеЧасыОстатки
          |		ПО втНачисления.Сотрудник = НаезженныеЧасыОстатки.Сотрудник
          |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПоказателиРасчетаЗарплаты.СрезПоследних(&ПериодРегистрации) КАК ПоказателиРасчетаЗарплатыСрезПоследних
          |		ПО (ИСТИНА)
          |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.ПределНаезженныхЧасов КАК ПределНаезженныхЧасов
          |		ПО (ИСТИНА)";

        ВидыРасчета = Новый Массив;
        ВидыРасчета.Добавить(ПланыВидовРасчета.ДополнительныеНачисления.КомпенсацияНаРемонт);
        Запрос.УстановитьПараметр("ВидыРасчета", ВидыРасчета);                             
        
        Измерения = Новый Массив;
        Измерения.Добавить("Сотрудник");
        Запрос.УстановитьПараметр("Измерения", Измерения);
        
        Запрос.УстановитьПараметр("НачалоСледующегоМесяца", ДобавитьМесяц(ПериодРегистрации, 1));
        Запрос.УстановитьПараметр("Регистратор", Ссылка);
        
        Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);	
          
        РезультатЗапроса = Запрос.Выполнить();
          
        Выборка = РезультатЗапроса.Выбрать();
        
        Для Каждого Движение Из Движения.ДополнительныеНачисления Цикл
          
          Если ВидыРасчета.Найти(Движение.ВидРасчета) = Неопределено Тогда
            Продолжить;			
          КонецЕсли;     
          
          Выборка.Сбросить();
          Выборка.НайтиСледующий(Движение.НомерСтроки, "НомерСтроки");
          Если Движение.ВидРасчета = ПланыВидовРасчета.ДополнительныеНачисления.КомпенсацияНаРемонт Тогда
            Если Выборка.НаезженоЧасов > Выборка.ПределНаезженныхЧасов Тогда
              Движение.Результат = Выборка.БазаНачислений * Выборка.ПроцентКомпенсации / 100;
              
              ДвижениеЧасы = Движения.НаезженныеЧасы.ДобавитьРасход();
              ДвижениеЧасы.Период = КонецРасчетногоПериода;
              ДвижениеЧасы.Сотрудник = Движение.Сотрудник;
              ДвижениеЧасы.Часов = Выборка.ПределНаезженныхЧасов;
              
              Движения.НаезженныеЧасы.Записывать = Истина;
              
            КонецЕсли;
            ЗаполнитьЗначенияСвойств(Движение, Выборка, "БазаНачислений, ПроцентКомпенсации, НаезженоЧасов, ПределНаезженныхЧасов");
          КонецЕсли;
          
        КонецЦикла;
        
        Движения.ДополнительныеНачисления.Записать();
        
      КонецПроцедуры

      <p>///// Документ РегистрацияНаезженныхЧасов</p>
      Процедура ОбработкаПроведения(Отказ, Режим)

        // регистр НаезженныеЧасы Приход
        Движения.НаезженныеЧасы.Записывать = Истина;
        Для Каждого ТекСтрокаСотрудники Из Сотрудники Цикл
          Движение = Движения.НаезженныеЧасы.Добавить();
          Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
          Движение.Период = Дата;
          Движение.Сотрудник = ТекСтрокаСотрудники.Сотрудник;
          Движение.Часов = ТекСтрокаСотрудники.Часов;
        КонецЦикла;

      КонецПроцедуры

      <p>///// Модуль объекта ЗаполнениеГрафика</p>
      Процедура ЗаполнитьГрафик(ДатаНачала, ДатаОкончания, ВыходныеДни) Экспорт 
        
        Набор = РегистрыСведений.ГрафикиРаботы.СоздатьНаборЗаписей();
        
        ЧислоСекундВСутках = 86400;
        
        Дат = ДатаНачала;	
        Пока Дат <= ДатаОкончания Цикл
          Запись = Набор.Добавить();
          Запись.Дата = Дат;
          Если Найти(ВыходныеДни, Строка(ДеньНедели(Дат))) Тогда
            Запись.Часов = 0;
            Запись.Дней = 0;
          Иначе	          
            Запись.Часов = 8;
            Запись.Дней = 1;
          КонецЕсли; 
          Дат = Дат + ЧислоСекундВСутках;
        КонецЦикла; 
        Набор.Записать();
        
      КонецПроцедуры

      <p>///// Модуль формы</p>
      &НаКлиенте
      Процедура Заполнить(Команда)
        ВыполнитьОбработку();
        Сообщить("Обработка завершена!");
      КонецПроцедуры

      &НаСервере
      Процедура ВыполнитьОбработку()
        ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
          ОбработкаОбъект.ЗаполнитьГрафик(ВыборПериода.ДатаНачала, ВыборПериода.ДатаОкончания, ВыходныеДни, ГрафикРаботы);
      КонецПроцедуры
    <embed src="pdf/ОбщееСПР3.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/СПР3.jpg">
      <img src="pdf/СПР3.1.jpg">
  </pre>
  <H2 class="OU">
    Бизнес процесс
  </H2>
  <pre>
    <p>//// ОбщегоНазначенияВызовСервера</p>  
Функция ТекущийПользователь() Экспорт
	
	Возврат ПараметрыСеанса.ТекущийПользователь;
		
КонецФункции 

<p>//// Контрагенты ФормаДвиженийБУ</p>
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Контрагент = Неопределено;
	Параметры.Свойство("Контрагент", Контрагент);
	Список.Параметры.УстановитьЗначениеПараметра("Контрагент", Контрагент);
КонецПроцедуры

<p>//// Контрагенты Команда ФормаДвиженийБУ</p> 
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ПараметрыФормы = Новый Структура("Контрагент", ПараметрКоманды);
	ОткрытьФорму("Справочник.Контрагенты.Форма.ФормаДвиженийБУ", ПараметрыФормы, 
									ПараметрыВыполненияКоманды.Источник, ПараметрыВыполненияКоманды.Уникальность, 
									ПараметрыВыполненияКоманды.Окно, ПараметрыВыполненияКоманды.НавигационнаяСсылка);
КонецПроцедуры
<p>//// Модуль сеанса</p>
 Процедура УстановкаПараметровСеанса(ТребуемыеПараметры)
	
	Имя = ПользователиИнформационнойБазы.ТекущийПользователь().Имя;
	
	ФизЛицо = Справочники.ФизическиеЛица.НайтиПоКоду(Имя);
	Если ФизЛицо.Пустая() Тогда
		ФизЛицоОбъект = Справочники.ФизическиеЛица.СоздатьЭлемент();
		ФизЛицоОбъект.Наименование = Имя;
		ФизЛицоОбъект.Код = Имя;
		ФизЛицоОбъект.Записать();
		ФизЛицо = ФизЛицоОбъект.Ссылка;
	КонецЕсли;

	ПараметрыСеанса.ТекущийПользователь = ФизЛицо;
		
КонецПроцедуры
  </pre>
  <embed src="pdf/ОбщееБП3.pdf" type="application/pdf" width="1200" height="800">
</body>

</html>
