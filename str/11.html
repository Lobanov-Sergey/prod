<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>HTML Document Template</title>
  <link href="styles.css" rel="stylesheet">
</head>

<body>
  <div class="header__menu">
    <ul>
      <li><a href="str/1">1</a></li>
      <li><a href="str/2">2</a></li>
      <li><a href="str/3">3</a></li>
      <li><a href="str/4">4</a></li>
      <li><a href="str/5">5</a></li>
      <li><a href="str/6">6</a></li>
      <li><a href="str/7">7</a></li>
      <li><a href="str/8">8</a></li>
      <li><a href="str/9">9</a></li>
      <li><a href="str/10">10</a></li>
      <li><a href="str/11">11</a></li>
      <li><a href="str/12">12</a></li>
      <li><a href="str/13">13</a></li>
      <li><a href="str/14">14</a></li>
      <li><a href="str/15">15</a></li>
      <li><a href="str/16">16</a></li>
    </ul>
  </div>
  <h1>11</h1>
  <H2 class="OU">
    Оперативный учет
  </H2>
  <pre>
    <p>///// Общий модуль ОбработкаТабличнойЧасти</p>
    Процедура РассчитатьСуммуВСтроке(ТекСтрока, РасчетСуммыПолучено = Ложь) Экспорт
      Если РасчетСуммыПолучено Тогда
        ТекСтрока.СуммаПолучено = ТекСтрока.Цена * ТекСтрока.КоличествоПолучено;
      Иначе
        ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
      КонецЕсли;
    КонецПроцедуры
    
    <p>///// Документ ПриходДенег</p>   
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.Взаиморасчеты.Записывать = Истина;
      Движения.Записать();
      
      Движения.Взаиморасчеты.Записывать = Истина;
      
      Блокировка = Новый БлокировкаДанных;
      ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.Взаиморасчеты");
      ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
      ЭлементБлокировки.УстановитьЗначение("Контрагент", Контрагент);
      ЭлементБлокировки.ИсточникДанных = СписокНакладных;
      ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Накладная", "Накладная");
      Блокировка.Заблокировать();
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ РАЗЛИЧНЫЕ
        |	ПриходДенегСписокНакладных.Накладная КАК Накладная,
        |	&Контрагент КАК Контрагент
        |ПОМЕСТИТЬ втТЧНакладные
        |ИЗ
        |	Документ.ПриходДенег.СписокНакладных КАК ПриходДенегСписокНакладных
        |ГДЕ
        |	ПриходДенегСписокНакладных.Ссылка = &Ссылка
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	Контрагент,
        |	Накладная
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втТЧНакладные.Накладная КАК Накладная,
        |	втТЧНакладные.Накладная.Представление КАК НакладнаяПредставление,
        |	ЕСТЬNULL(ВзаиморасчетыОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
        |	втТЧНакладные.Контрагент КАК Контрагент
        |ПОМЕСТИТЬ втДолгиПоНакладным
        |ИЗ
        |	втТЧНакладные КАК втТЧНакладные
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Взаиморасчеты.Остатки(
        |				&МоментВремени,
        |				(Контрагент, Накладная) В
        |					(ВЫБРАТЬ
        |						втТЧНакладные.Контрагент,
        |						втТЧНакладные.Накладная
        |					ИЗ
        |						втТЧНакладные КАК втТЧНакладные)) КАК ВзаиморасчетыОстатки
        |		ПО втТЧНакладные.Накладная = ВзаиморасчетыОстатки.Накладная
        |			И втТЧНакладные.Контрагент = ВзаиморасчетыОстатки.Контрагент
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втДолгиПоНакладным.Накладная.Представление КАК НакладнаяПредставление
        |ИЗ
        |	втДолгиПоНакладным КАК втДолгиПоНакладным
        |ГДЕ
        |	втДолгиПоНакладным.СуммаОстаток = 0
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втДолгиПоНакладным.Накладная КАК Накладная,
        |	втДолгиПоНакладным.НакладнаяПредставление КАК НакладнаяПредставление,
        |	втДолгиПоНакладным.СуммаОстаток КАК СуммаОстаток,
        |	&Период КАК Период,
        |	втДолгиПоНакладным.Контрагент КАК Контрагент
        |ИЗ
        |	втДолгиПоНакладным КАК втДолгиПоНакладным
        |
        |УПОРЯДОЧИТЬ ПО
        |	втДолгиПоНакладным.Накладная.МоментВремени
        |ИТОГИ
        |	СУММА(СуммаОстаток)
        |ПО
        |	ОБЩИЕ";
      
      Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
      Запрос.УстановитьПараметр("Период", Дата);
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      Запрос.УстановитьПараметр("Контрагент", Контрагент);
      
      РезультатыЗапросов = Запрос.ВыполнитьПакет();
      
      РезультатПроверка = РезультатыЗапросов[2];
      Если Не РезультатПроверка.Пустой() Тогда
        Отказ = Истина;
        
        Выборка = РезультатПроверка.Выбрать();
        Пока Выборка.Следующий() Цикл
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = СтрШаблон("По накладной %1 нет долга", Выборка.НакладнаяПредставление);
          Сообщение.Сообщить();
        КонецЦикла;
        
        Возврат;
      КонецЕсли;
        
      ВыборкаОбщийИтог = РезультатыЗапросов[3].Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
      
      ВыборкаОбщийИтог.Следующий();
      
      ДолгПоВсемНакладным = ВыборкаОбщийИтог.СуммаОстаток;
      
      Если СуммаОплаты > ДолгПоВсемНакладным Тогда
        Отказ = Истина;
        
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = СтрШаблон("Сумма оплаты не должна превышать суммарный долг по накладным (он равен %1)",
        ДолгПоВсемНакладным);
        Сообщение.Сообщить();
        
        Возврат;
      КонецЕсли;
      
      СуммаКОплате = СуммаОплаты;
      
      ВыборкаДетальныеЗаписи = ВыборкаОбщийИтог.Выбрать();
      
      Пока ВыборкаДетальныеЗаписи.Следующий() И СуммаКОплате > 0 Цикл
        
        Сумма = Мин(СуммаКОплате, ВыборкаДетальныеЗаписи.СуммаОстаток);
        
        Движение = Движения.Взаиморасчеты.ДобавитьРасход();
        ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
        Движение.Сумма = Сумма;
        
        СуммаКОплате = СуммаКОплате - Сумма;
        
      КонецЦикла;
      
    КонецПроцедуры
     
    <p>///// Документ ПриходнаяНакладная</p>
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    Процедура ОбработкаПроведения(Отказ, Режим)
    
      Движения.ОстаткиНоменклатуры.Записывать = Истина;
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
        |ИЗ
        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
        |
        |СГРУППИРОВАТЬ ПО
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура";
      
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Пока Выборка.Следующий() Цикл
        Движение = Движения.ОстаткиНоменклатуры.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
        Движение.Период = Дата;
        Движение.Номенклатура = Выборка.Номенклатура;
        Движение.Количество = Выборка.Количество;		
      КонецЦикла;
       
    КонецПроцедуры
    
    <p>///// Документ РасходнаяНакладная</p> 
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаОтгружено   = СписокНоменклатуры.Итог("Сумма");
      СуммаПоДокументу = СписокНоменклатуры.Итог("СуммаПолучено");
    КонецПроцедуры
    
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.ТоварыОтгруженные.Записывать = Истина;
      Движения.ТоварыПолученные.Записывать  = Истина;
      Движения.Взаиморасчеты.Записывать = Истина;
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.Представление КАК НоменклатураПредставление,
        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма,
        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.КоличествоПолучено) КАК КоличествоПолучено,
        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.СуммаПолучено) КАК СуммаПолучено,
        |	&Период КАК Период
        |ИЗ
        |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
        |
        |СГРУППИРОВАТЬ ПО
        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.Представление";
      
      Запрос.УстановитьПараметр("Период", Дата);
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Пока Выборка.Следующий() Цикл
        Если Выборка.КоличествоПолучено > Выборка.Количество Тогда
          Отказ = Истина;
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = СтрШаблон("Получено больше товара %1, чем было отгружено", 
          Выборка.НоменклатураПредставление);
          Сообщение.Сообщить();
        КонецЕсли;
        
        Если Отказ Тогда
          Продолжить;
        КонецЕсли;
        
        Движение = Движения.ТоварыОтгруженные.Добавить();
        ЗаполнитьЗначенияСвойств(Движение, Выборка);
        
        Если Выборка.КоличествоПолучено > 0 Тогда
          Движение = Движения.ТоварыПолученные.Добавить();
          ЗаполнитьЗначенияСвойств(Движение, Выборка);		
          Движение.Количество = Выборка.КоличествоПолучено;
          Движение.Сумма = Выборка.СуммаПолучено;
        КонецЕсли;			
      КонецЦикла;
      
      Если Отказ Тогда
        Возврат;
      КонецЕсли;
      
      Если СуммаПоДокументу > 0 Тогда		
        Движение = Движения.Взаиморасчеты.ДобавитьПриход();
        Движение.Период = Дата;
        Движение.Контрагент = Контрагент;
        Движение.Накладная = Ссылка;
        Движение.Сумма = СуммаПоДокументу;
      КонецЕсли;
      
    КонецПроцедуры
    
    <p>///// Модуль формы</p>
    &НаКлиенте
    Процедура СписокНоменклатурыКоличествоПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    
    &НаКлиенте
    Процедура СписокНоменклатурыЦенаПриИзменении(Элемент)
      ТекСтрока = Элементы.СписокНоменклатуры.ТекущиеДанные;
      ОбработкаТабличнойЧасти.РассчитатьСуммуВСтроке(ТекСтрока);
    КонецПроцедуры
    <embed src="pdf/ОбщееОУ11.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/ОУ11.jpg">
    <H2 class="OU">
      Бухгалтерский учет
    </H2>
    <p>///// Общий модуль ОбработкаТабличнойЧастиКлиент</p>
    Процедура РассчитатьСуммуВСтроке(ТекСтрока) Экспорт
      ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
    КонецПроцедуры 
    
    <p>///// Документ Операция</p>   
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      Если Не Движения.Управленческий.Записывать Тогда
        Движения.Управленческий.Прочитать();
        Движения.Управленческий.Записывать = Истина;
      КонецЕсли;
      
      Для Каждого Движение Из Движения.Управленческий Цикл
        Движение.Период = Дата;
        Движение.Активность = Не ПометкаУдаления;
      КонецЦикла;
    КонецПроцедуры
    
    Процедура ПриКопировании(ОбъектКопирования)	
      Выборка = РегистрыБухгалтерии.Управленческий.ВыбратьПоРегистратору(ОбъектКопирования.Ссылка);
      Пока Выборка.Следующий() Цикл
        Движение = Движения.Управленческий.Добавить();
        ЗаполнитьЗначенияСвойств(Движение, Выборка);
        ЗаполнитьЗначенияСвойств(Движение.СубконтоДт, Выборка.СубконтоДт);
        ЗаполнитьЗначенияСвойств(Движение.СубконтоКт, Выборка.СубконтоКт);
      КонецЦикла;
    КонецПроцедуры
     
    <p>///// Документ ПриходнаяНакладная</p>
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    <p>///// Документ РасходнаяНакладная</p> 
    Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
      СуммаПоДокументу = СписокНоменклатуры.Итог("Сумма");
    КонецПроцедуры
    
    <p>///// Документ Отправление</p>
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.Управленческий.Записывать = Истина;
      Движения.Записать();
      
      Движения.Управленческий.Записывать = Истина;
      
      Блокировка = Новый БлокировкаДанных;
      ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
      ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
      ЭлементБлокировки.УстановитьЗначение("Счет", ПланыСчетов.Управленческий.Товары);
      ЭлементБлокировки.УстановитьЗначение(ПланыВидовХарактеристик.ВидыСубконто.Склады, Склад);
      ЭлементБлокировки.ИсточникДанных = СписокНоменклатуры;
      ЭлементБлокировки.ИспользоватьИзИсточникаДанных(ПланыВидовХарактеристик.ВидыСубконто.Номенклатура, "Номенклатура");
      Блокировка.Заблокировать();
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	ОтправлениеСписокНоменклатуры.Номенклатура КАК Номенклатура,
        |	СУММА(ОтправлениеСписокНоменклатуры.Количество) КАК Количество
        |ПОМЕСТИТЬ втТЧТовары
        |ИЗ
        |	Документ.Отправление.СписокНоменклатуры КАК ОтправлениеСписокНоменклатуры
        |ГДЕ
        |	ОтправлениеСписокНоменклатуры.Ссылка = &Ссылка
        |
        |СГРУППИРОВАТЬ ПО
        |	ОтправлениеСписокНоменклатуры.Номенклатура
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	Номенклатура
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втТЧТовары.Номенклатура КАК Номенклатура,
        |	втТЧТовары.Номенклатура.Представление КАК НоменклатураПредставление,
        |	втТЧТовары.Количество КАК Количество,
        |	ЕСТЬNULL(УправленческийОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
        |	ЕСТЬNULL(УправленческийОстатки.СуммаОстаток, 0) КАК СуммаОстаток
        |ИЗ
        |	втТЧТовары КАК втТЧТовары
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Управленческий.Остатки(
        |				&МоментВремени,
        |				Счет = &СчетТовары,
        |				&ВидыСубконто,
        |				Субконто1 В
        |						(ВЫБРАТЬ
        |							втТЧТовары.Номенклатура КАК Номенклатура
        |						ИЗ
        |							втТЧТовары КАК втТЧТовары)
        |					И Субконто2 = &Склад) КАК УправленческийОстатки
        |		ПО втТЧТовары.Номенклатура = УправленческийОстатки.Субконто1";
      
      ВидыСубконто = Новый Массив;
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Номенклатура);
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Склады);
      
      Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
      Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
      Запрос.УстановитьПараметр("Склад", Склад);
      Запрос.УстановитьПараметр("Ссылка", Ссылка);
      Запрос.УстановитьПараметр("СчетТовары", ПланыСчетов.Управленческий.Товары);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Пока Выборка.Следующий() Цикл
        
        Если Выборка.Количество > Выборка.КоличествоОстаток Тогда
          Отказ = Истина;
          Сообщение = Новый СообщениеПользователю;
          Сообщение.Текст = СтрШаблон("Недостаточно товара %1 в количестве %2",
          Выборка.НоменклатураПредставление, Выборка.Количество - Выборка.КоличествоОстаток);
          Сообщение.Сообщить();
        КонецЕсли;
        
        Если Отказ Тогда
          Продолжить;
        КонецЕсли;
        
        Если Выборка.Количество = Выборка.КоличествоОстаток Тогда
          Себестоимость = Выборка.СуммаОстаток;
        Иначе
          Себестоимость = Выборка.СуммаОстаток / Выборка.КоличествоОстаток * Выборка.Количество;
        КонецЕсли;
        
        Движение = Движения.Управленческий.Добавить();
        Движение.Период = Дата;
        Движение.СчетДт = ПланыСчетов.Управленческий.ТоварыВПути;
        Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Номенклатура;
        Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.ДокументыОтправления] = Ссылка;
        Движение.КоличествоДт = Выборка.Количество;
        
        Движение.СчетКт = ПланыСчетов.Управленческий.Товары;
        Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Номенклатура;
        Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Склады] = Склад;
        Движение.КоличествоКт = Выборка.Количество;
        Движение.Сумма = Себестоимость;
        
      КонецЦикла;
    
    КонецПроцедуры
    
    <p>///// Документ Прибытие</p> 
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      Движения.Управленческий.Записывать = Истина;
      Движения.Записать();
      
      Движения.Управленческий.Записывать = Истина;
      
      Блокировка = Новый БлокировкаДанных;
      ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
      ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
      ЭлементБлокировки.УстановитьЗначение("Счет", ПланыСчетов.Управленческий.ТоварыВПути);
      ЭлементБлокировки.УстановитьЗначение(ПланыВидовХарактеристик.ВидыСубконто.ДокументыОтправления, ДокументОтправления);
      Блокировка.Заблокировать();
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	УправленческийОстатки.Субконто1 КАК Номенклатура,
        |	УправленческийОстатки.КоличествоОстаток КАК КоличествоОстаток,
        |	УправленческийОстатки.СуммаОстаток КАК СуммаОстаток
        |ИЗ
        |	РегистрБухгалтерии.Управленческий.Остатки(&МоментВремени, Счет = &СчетТоварыВПути, &ВидыСубконто, Субконто2 = &ДокументОтправления) КАК УправленческийОстатки";
      
      ВидыСубконто = Новый Массив;
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Номенклатура);
      ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.ДокументыОтправления);
      
      Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
      
      Запрос.УстановитьПараметр("ДокументОтправления", ДокументОтправления);
      Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
      Запрос.УстановитьПараметр("СчетТоварыВПути", ПланыСчетов.Управленческий.ТоварыВПути);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Если РезультатЗапроса.Пустой() Тогда
        Отказ = Истина;
        
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Нет данных для формирования документа";
        Сообщение.Сообщить();
        
        Возврат;
      КонецЕсли;
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Пока Выборка.Следующий() Цикл		
        Движение = Движения.Управленческий.Добавить();
        Движение.Период = Дата;
        Движение.СчетДт = ПланыСчетов.Управленческий.Товары;
        Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Номенклатура;
        Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Склады] = Склад;
        Движение.КоличествоДт = Выборка.КоличествоОстаток;
        
        Движение.СчетКт = ПланыСчетов.Управленческий.ТоварыВПути;
        Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Номенклатура;
        Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.ДокументыОтправления] = ДокументОтправления;
        Движение.КоличествоКт = Выборка.КоличествоОстаток;
        
        Движение.Сумма = Выборка.СуммаОстаток;		
      КонецЦикла;
        
    КонецПроцедуры
    
    Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
      Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.Отправление") Тогда
        ДокументОтправления = ДанныеЗаполнения;
      КонецЕсли;
    КонецПроцедуры
    
    <p>///// Модуль формы Прибытие</p>
    &НаСервере
    Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
      
      Если Не ЗначениеЗаполнено(Объект.ДокументОтправления) Тогда
        Сообщение = Новый СообщениеПользователю;
        Сообщение.Текст = "Этот документ можно создать только на основании документа ""Отправление""";
        Сообщение.Сообщить();	
        Отказ = Истина;
      КонецЕсли;
      
    КонецПроцедуры
    <embed src="pdf/ОбщееБУ11.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/БУ11.jpg">
    <H2 class="OU">
      Расчеты
    </H2>
    <p>///// Документ НачислениеЗарплаты</p>   
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
      
      ПериодРегистрации = НачалоМесяца(Дата);
        
      Движения.ОсновныеНачисления.Записывать = Истина;
      Для Каждого Строка Из ОсновныеНачисления Цикл
        Движение = Движения.ОсновныеНачисления.Добавить();
        ЗаполнитьЗначенияСвойств(Движение, Строка);
        Движение.ПериодРегистрации = ПериодРегистрации;
        Движение.ПериодДействияНачало = Строка.ДатаНачала;
        Движение.ПериодДействияКонец = КонецДня(Строка.ДатаОкончания);
      КонецЦикла;                                                       
      Движения.Записать();
      
      Запрос = Новый Запрос;
      Запрос.Текст = 
        "ВЫБРАТЬ
        |	ОсновныеНачисления.НомерСтроки КАК НомерСтроки,
        |	ОсновныеНачисления.Сотрудник КАК Сотрудник,
        |	ОсновныеНачисления.Подразделение КАК Подразделение,
        |	ОсновныеНачисления.ПериодДействияНачало КАК ПериодДействияНачало,
        |	ОсновныеНачисления.ПериодДействияКонец КАК ПериодДействияКонец,
        |	ОсновныеНачисления.ВидРасчета КАК ВидРасчета
        |ПОМЕСТИТЬ втДанныеНачислений
        |ИЗ
        |	РегистрРасчета.ОсновныеНачисления КАК ОсновныеНачисления
        |ГДЕ
        |	ОсновныеНачисления.Регистратор = &Регистратор
        |	И ОсновныеНачисления.ВидРасчета В(&ВидыРасчета)
        |	И ОсновныеНачисления.Активность
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	Сотрудник,
        |	Подразделение
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втДанныеНачислений.НомерСтроки КАК НомерСтроки,
        |	СУММА(ЕСТЬNULL(ДанныеТабеляОбороты.ЧасовОборот, 0)) КАК Часов
        |ПОМЕСТИТЬ втДанныеЯвки
        |ИЗ
        |	втДанныеНачислений КАК втДанныеНачислений
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ДанныеТабеля.Обороты(
        |				&ПериодРегистрации,
        |				&КонецПериодаРегистрации,
        |				День,
        |				(Сотрудник, Подразделение) В
        |						(ВЫБРАТЬ
        |							втДанныеНачислений.Сотрудник КАК Сотрудник,
        |							втДанныеНачислений.Подразделение КАК Подразделение
        |						ИЗ
        |							втДанныеНачислений КАК втДанныеНачислений
        |						ГДЕ
        |							втДанныеНачислений.ВидРасчета В (&ВидыРасчетаЯвки))
        |					И ВидВремени = ЗНАЧЕНИЕ(Справочник.ВидыВремени.Явка)) КАК ДанныеТабеляОбороты
        |		ПО втДанныеНачислений.Сотрудник = ДанныеТабеляОбороты.Сотрудник
        |			И втДанныеНачислений.Подразделение = ДанныеТабеляОбороты.Подразделение
        |			И втДанныеНачислений.ПериодДействияНачало <= ДанныеТабеляОбороты.Период
        |			И втДанныеНачислений.ПериодДействияКонец >= ДанныеТабеляОбороты.Период
        |ГДЕ
        |	втДанныеНачислений.ВидРасчета В(&ВидыРасчетаЯвки)
        |
        |СГРУППИРОВАТЬ ПО
        |	втДанныеНачислений.НомерСтроки
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	НомерСтроки
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втДанныеНачислений.НомерСтроки КАК НомерСтроки,
        |	СУММА(ЕСТЬNULL(ДанныеТабеляОбороты.ДнейОборот, 0)) КАК Дней
        |ПОМЕСТИТЬ втДанныеНевыходов
        |ИЗ
        |	втДанныеНачислений КАК втДанныеНачислений
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ДанныеТабеля.Обороты(
        |				&ПериодРегистрации,
        |				&КонецПериодаРегистрации,
        |				День,
        |				(Сотрудник, Подразделение) В
        |						(ВЫБРАТЬ
        |							втДанныеНачислений.Сотрудник КАК Сотрудник,
        |							втДанныеНачислений.Подразделение КАК Подразделение
        |						ИЗ
        |							втДанныеНачислений КАК втДанныеНачислений
        |						ГДЕ
        |							втДанныеНачислений.ВидРасчета В (&ВидыРасчетаНевыходы))
        |					И ВидВремени = ЗНАЧЕНИЕ(Справочник.ВидыВремени.Невыход)) КАК ДанныеТабеляОбороты
        |		ПО втДанныеНачислений.Сотрудник = ДанныеТабеляОбороты.Сотрудник
        |			И втДанныеНачислений.Подразделение = ДанныеТабеляОбороты.Подразделение
        |			И втДанныеНачислений.ПериодДействияНачало <= ДанныеТабеляОбороты.Период
        |			И втДанныеНачислений.ПериодДействияКонец >= ДанныеТабеляОбороты.Период
        |ГДЕ
        |	втДанныеНачислений.ВидРасчета В(&ВидыРасчетаНевыходы)
        |
        |СГРУППИРОВАТЬ ПО
        |	втДанныеНачислений.НомерСтроки
        |
        |ИНДЕКСИРОВАТЬ ПО
        |	НомерСтроки
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |	втДанныеНачислений.НомерСтроки КАК НомерСтроки,
        |	ЕСТЬNULL(втДанныеЯвки.Часов, 0) КАК ОтработаноЧасов,
        |	ЕСТЬNULL(СведенияОСотрудникахСрезПоследних.ТарифнаяСтавка, 0) КАК ТарифнаяСтавка,
        |	ЕСТЬNULL(втДанныеНевыходов.Дней, 0) КАК ДнейНевыхода
        |ИЗ
        |	втДанныеНачислений КАК втДанныеНачислений
        |		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеЯвки КАК втДанныеЯвки
        |		ПО втДанныеНачислений.НомерСтроки = втДанныеЯвки.НомерСтроки
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОСотрудниках.СрезПоследних(
        |				&ПериодРегистрации,
        |				(Сотрудник, Подразделение) В
        |					(ВЫБРАТЬ
        |						втДанныеНачислений.Сотрудник КАК Сотрудник,
        |						втДанныеНачислений.Подразделение КАК Подразделение
        |					ИЗ
        |						втДанныеНачислений КАК втДанныеНачислений)) КАК СведенияОСотрудникахСрезПоследних
        |		ПО втДанныеНачислений.Сотрудник = СведенияОСотрудникахСрезПоследних.Сотрудник
        |			И втДанныеНачислений.Подразделение = СведенияОСотрудникахСрезПоследних.Подразделение
        |		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеНевыходов КАК втДанныеНевыходов
        |		ПО втДанныеНачислений.НомерСтроки = втДанныеНевыходов.НомерСтроки";
    
      ВидыРасчета = Новый Массив;
      ВидыРасчета.Добавить(ПланыВидовРасчета.ОсновныеНачисления.ОплатаПоЧасовомуТарифу);
      ВидыРасчета.Добавить(ПланыВидовРасчета.ОсновныеНачисления.Невыход);
      Запрос.УстановитьПараметр("ВидыРасчета", ВидыРасчета);
      
      ВидыРасчетаЯвки = Новый Массив;
      ВидыРасчетаЯвки.Добавить(ПланыВидовРасчета.ОсновныеНачисления.ОплатаПоЧасовомуТарифу);
      Запрос.УстановитьПараметр("ВидыРасчетаЯвки", ВидыРасчетаЯвки);
      
      ВидыРасчетаНевыходы = Новый Массив;
      ВидыРасчетаНевыходы.Добавить(ПланыВидовРасчета.ОсновныеНачисления.Невыход);	
      Запрос.УстановитьПараметр("ВидыРасчетаНевыходы", ВидыРасчетаНевыходы);
      
      Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
      Запрос.УстановитьПараметр("КонецПериодаРегистрации", КонецМесяца(ПериодРегистрации));
      
      Запрос.УстановитьПараметр("Регистратор", Ссылка);
      
      РезультатЗапроса = Запрос.Выполнить();
      
      Выборка = РезультатЗапроса.Выбрать();
      
      Для Каждого Движение Из Движения.ОсновныеНачисления Цикл
        
        Если ВидыРасчета.Найти(Движение.ВидРасчета) = Неопределено Тогда
          Продолжить;
        КонецЕсли;
        
        Выборка.Сбросить();
        Выборка.НайтиСледующий(Движение.НомерСтроки, "НомерСтроки");
        
        Если Движение.ВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.ОплатаПоЧасовомуТарифу Тогда
          Движение.Результат = Выборка.ОтработаноЧасов * Выборка.ТарифнаяСтавка;
          ЗаполнитьЗначенияСвойств(Движение, Выборка, "ОтработаноЧасов, ТарифнаяСтавка");
        ИначеЕсли Движение.ВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Невыход Тогда
          Движение.Результат = 0;
          ЗаполнитьЗначенияСвойств(Движение, Выборка, "ДнейНевыхода");
        КонецЕсли;
        
      КонецЦикла;
      
      Движения.ОсновныеНачисления.Записать(, Истина);
      
    КонецПроцедуры
    
    <p>///// Документ Табель</p>
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    
      ПериодРегистрации = НачалоМесяца(Дата);
      
      Движения.ДанныеТабеля.Записывать = Истина;
      
      Для Каждого Строка Из ДанныеТабеля Цикл
        
        ПоследнийДеньМесяца = День(КонецМесяца(Дата));
        
        Для НомерДня = 1 По ПоследнийДеньМесяца Цикл
          
          ЗначениеЯчейки = ВРег(СокрЛП(Строка["День" + НомерДня]));
          
          Если ЗначениеЯчейки <> "" Тогда
            
            Период = ПериодРегистрации + (НомерДня - 1)*24*3600;
            
            Попытка
              Если ЗначениеЯчейки = "Н" Тогда
                ВидВремени = Справочники.ВидыВремени.Невыход;	
                Часов = 0;	
              Иначе	
                ВидВремени = Справочники.ВидыВремени.Явка;
                Часов = Число(ЗначениеЯчейки);
              КонецЕсли;
            Исключение
              Сообщение = Новый СообщениеПользователю;
              Сообщение.Текст = СтрШаблон("Некорректный ввод данных (строка %1, день %2)", Строка.НомерСтроки, НомерДня);
              Сообщение.Сообщить();
              Продолжить;
              Отказ = Истина;
            КонецПопытки;
            
            Движение = Движения.ДанныеТабеля.Добавить();
            Движение.Период = Период;
            Движение.Сотрудник = Строка.Сотрудник;
            Движение.Подразделение = Подразделение;
            Движение.ВидВремени = ВидВремени;
            Движение.Часов = Часов;
            Движение.Дней = 1;
        
          КонецЕсли;
          
        КонецЦикла;
        
      КонецЦикла;
      
    КонецПроцедуры
    
    <p>///// Модуль объекта ЗаполнениеГрафика</p>
    Процедура ЗаполнитьГрафик(ДатаНачала, ДатаОкончания, ВыходныеДни, ГрафикРаботы) Экспорт 
      
      Набор = РегистрыСведений.ГрафикиРаботы.СоздатьНаборЗаписей();
      
      Набор.Отбор.ГрафикРаботы.Установить(ГрафикРаботы);
        
      ЧислоСекундВСутках = 86400;
      
      Дат = ДатаНачала;	
      Пока Дат <= ДатаОкончания Цикл
        Запись = Набор.Добавить();
        Запись.ГрафикРаботы = ГрафикРаботы;
        Запись.Дата = Дат;
        Если Найти(ВыходныеДни, Строка(ДеньНедели(Дат))) Тогда
          Запись.Значение = 0;
        Иначе	          
          Запись.Значение = 8;
        КонецЕсли; 
        Дат = Дат + ЧислоСекундВСутках;
      КонецЦикла; 
      Набор.Записать();
    КонецПроцедуры
    
    <p>///// Модуль формы</p>
    &НаКлиенте
    Процедура Заполнить(Команда)
      ВыполнитьОбработку();
      Сообщить("Обработка завершена!");
    КонецПроцедуры
    
    &НаСервере
    Процедура ВыполнитьОбработку()
      ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
        ОбработкаОбъект.ЗаполнитьГрафик(ВыборПериода.ДатаНачала, ВыборПериода.ДатаОкончания, ВыходныеДни, ГрафикРаботы);
    КонецПроцедуры
    <embed src="pdf/ОбщееСПР11.pdf" type="application/pdf" width="1200" height="800">
      <img src="pdf/СПР11.jpg">
  </pre>
</body>

</html>